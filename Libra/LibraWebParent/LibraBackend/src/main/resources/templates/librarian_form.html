<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments :: page_head(${pageTitle})"/>

<body>
<div class="container-fluid">

  <!-- navigation -->
  <div th:replace="navigation::menu"></div>

  <!-- user form -->
  <div class="mb-5">
    <h2>Quản Lý Thủ Thư | [[${pageTitle}]]</h2>
  </div>
  <!-- user form -->

  <form th:action="@{/librarians/save}" method="post" style="max-width: 700px; margin: 0 auto" th:object="${librarian}"
        onsubmit="return checkEmailUnique(this);" enctype="multipart/form-data">
    <input type="hidden" th:field="*{id}"/>
    <div class="border border-secondary rounded p-3">
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">E-mail</label>
        <div class="col-sm-8">
          <!-- map attribute with entity -->
          <input type="email" class="form-control" required minlength="8" maxlength="128"
                 th:field="*{email}"/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Tên</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" required th:field="*{firstName}"/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Họ</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" required th:field="*{lastName}"/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Mật khẩu</label>
        <div class="col-sm-8">
          <input th:if="${librarian.id == null}" type="password" class="form-control" required minlength="8"
                 maxlength="64" th:field="*{password}"/>
          <input th:if="${librarian.id != null}" type="password" class="form-control" minlength="8" maxlength="64"
                 th:field="*{password}" placeholder="Để trống nếu bạn không muốn thay đổi mật khẩu"/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Căn cước công dân</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" required minlength="9" maxlength="12"
                 th:field="*{citizenIdentification}"/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Số điện thoại</label>
        <div class="col-sm-8">
          <input type="text" class="form-control" required th:field="*{phoneNumber}"/>
        </div>
      </div>
      <div class="form-group row">
        <label class="col-sm-4 col-form-label">Kích hoạt:</label>
        <div class="col-sm-8 mt-2">
          <input type="checkbox" th:field="*{enabled}"/>
        </div>
      </div>
      <input type="hidden" th:field="*{role}"/>
      <div class="text-center">
        <input type="submit" value="Save" class="btn btn-primary m-3"/>
        <input type="button" value="Cancel" class="btn btn-secondary" id="btnCancel">
      </div>
    </div>
  </form>

  <!-- modal -->
  <div class="modal fade text-center" id="modalDialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modalTitle">Warning</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <span id="modalBody"></span>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- modal -->

  <!-- footer -->
  <div th:replace="fragments :: footer"></div>

</div>

<script type="text/javascript">
  $(document).ready(function () {

    // navigate when pressing cancel button
    $("#btnCancel").on("click", function () {
      window.location = "[[@{/librarians}]]";
    });
  });

  function checkEmailUnique(form) {
    url = "[[@{/librarians/check_email}]]";
    librarianEmail = $("#email").val(); // email of th:field, val() get the value of an input
    librarianId = $("#id").val();
    csrfValue = $("input[name='_csrf']").val();

    params = {id: librarianId, email: librarianEmail, _csrf: csrfValue}; // csrf token of spring security

    $.post(url, params, function (response) { // method post => url, data, callback
      if (response == "OK") {
        form.submit();
      } else if (response == "Duplicated") {
        showModalDialog("Warning", "Email " + librarianEmail + " đã tồn tại !")
      } else {
        showModalDialog("Error", "Unknown response from server");
      }
    }).fail(function () {
      showModalDialog("Error", "Could not connect to the server"); // this line runs when the above url is wrong
    });

    return false;
  }

  function showModalDialog(title, message) {
    $("#modalTitle").text(title);
    $("#modalBody").text(message);
    $("#modalDialog").modal();
  }
</script>

</body>
</html>
